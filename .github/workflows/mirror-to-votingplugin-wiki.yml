name: Mirror to VotingPlugin GitHub Wiki

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: mirror-votingplugin-wiki
  cancel-in-progress: true

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout BenCodez/Wiki (source)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clone VotingPlugin GitHub Wiki repo (destination)
        env:
          WIKI_PUSH_TOKEN: ${{ secrets.WIKI_PUSH_TOKEN }}
        run: |
          set -euo pipefail
          rm -rf /tmp/vp-wiki
          git clone "https://x-access-token:${WIKI_PUSH_TOKEN}@github.com/BenCodez/VotingPlugin.wiki.git" /tmp/vp-wiki

      - name: Mirror files into the Wiki repo (Wiki.js cleanup)
        run: |
          set -euo pipefail

          SRC="$GITHUB_WORKSPACE"
          DST="/tmp/vp-wiki"

          # Clean destination (keep .git)
          find "$DST" -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          # Copy source content
          rsync -a --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude ".gitignore" \
            "$SRC/" "$DST/"

          # GitHub Wiki front page
          if [ -f "$DST/home.md" ]; then
            mv "$DST/home.md" "$DST/Home.md"
          fi

          # GitHub Wiki sidebar
          if [ -f "$DST/sidebar.md" ]; then
            mv "$DST/sidebar.md" "$DST/_Sidebar.md"
          fi

          # ------------------------------------------------------------
          # Robust cleanup for ALL markdown files:
          # 1) Remove ANY leading YAML front-matter block(s) at the top:
          #    ---
          #    ...anything...
          #    ---
          #    (repeat if multiple)
          #
          # 2) Remove leading Wiki.js metadata key lines (even if not in --- ---):
          #    title:, description:, published:, date:, tags:, editor:, dateCreated:
          #
          # 3) Trim extra leading blank lines
          # ------------------------------------------------------------
          find "$DST" -type f -name "*.md" -print0 | while IFS= read -r -d '' f; do
            perl -0777 -i -pe '
              # Remove UTF-8 BOM if present
              s/\A\x{FEFF}//;

              # Repeatedly remove YAML front-matter blocks at file start
              # Allows leading whitespace/blank lines before the first ---
              while (s/\A[ \t\r\n]*---[ \t]*\R.*?\R---[ \t]*\R?//s) {}

              # Now remove leading Wiki.js metadata lines (known keys) and leading blanks
              my @lines = split(/\R/, $_, -1);
              my $i = 0;

              while ($i < @lines) {
                my $l = $lines[$i];

                # drop leading blank lines
                if ($l =~ /^[ \t]*$/) { $i++; next; }

                # drop known metadata lines
                if ($l =~ /^[ \t]*(title|description|published|date|tags|editor|dateCreated):/i) { $i++; next; }

                last;
              }

              $_ = join("\n", @lines[$i .. $#lines]);
            ' "$f"
          done

          # ------------------------------------------------------------
          # Remove markdown-it / Wiki.js attribute-only lines
          # Example: "{.is-warning}"
          # ------------------------------------------------------------
          find "$DST" -type f -name "*.md" -print0 | xargs -0 sed -i -E \
            '/^[[:space:]]*\{[[:space:]]*(\.[A-Za-z0-9_-]+)([[:space:]]+\.[A-Za-z0-9_-]+)*[[:space:]]*\}[[:space:]]*$/d'

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          cd /tmp/vp-wiki

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to push."
            exit 0
          fi

          git commit -m "Mirror from BenCodez/Wiki (cleaned for GitHub Wiki)"
          git push
